name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

env:
  NODE_VERSION: '18.x'

jobs:
  validate-pr:
    name: Validate Pull Request
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate branch name
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          
          # Allowed branch name patterns
          if [[ ! "$BRANCH_NAME" =~ ^(feature|fix|hotfix|refactor|docs|test)/.+ ]]; then
            echo "âŒ Invalid branch name: $BRANCH_NAME"
            echo "âœ… Branch names must follow pattern: feature/name, fix/name, hotfix/name, etc."
            exit 1
          fi
          
          echo "âœ… Branch name is valid: $BRANCH_NAME"

      - name: Check PR target branch
        run: |
          BASE_BRANCH="${{ github.base_ref }}"
          HEAD_BRANCH="${{ github.head_ref }}"
          
          # Prevent direct pushes to main/master
          if [[ "$HEAD_BRANCH" == "main" || "$HEAD_BRANCH" == "master" ]]; then
            echo "âŒ Cannot create PR from main/master branch"
            echo "âœ… Please create a feature branch first"
            exit 1
          fi
          
          # Prevent PRs from develop to develop
          if [[ "$BASE_BRANCH" == "develop" && "$HEAD_BRANCH" == "develop" ]]; then
            echo "âŒ Cannot create PR from develop to develop"
            echo "âœ… Please create a feature branch first"
            exit 1
          fi
          
          echo "âœ… PR target branch is valid: $BASE_BRANCH"

      - name: Check commit messages
        run: |
          # Get commits in this PR
          git log --oneline ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | while read commit; do
            if [[ ! "$commit" =~ ^[a-f0-9]+\ (feat|fix|docs|style|refactor|test|chore)(\(.+\))?: ]]; then
              echo "âš ï¸  Commit message doesn't follow convention: $commit"
              echo "âœ… Use format: type(scope): description"
              echo "   Types: feat, fix, docs, style, refactor, test, chore"
            fi
          done

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for lint script
        id: check-lint
        run: |
          if grep -q '"lint"' package.json; then
            echo "has_lint=true" >> $GITHUB_OUTPUT
          else
            echo "has_lint=false" >> $GITHUB_OUTPUT
          fi

      - name: Run linter
        if: steps.check-lint.outputs.has_lint == 'true'
        run: npm run lint

      - name: Build application
        run: npm run build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL_DEV || 'http://localhost:5000/api' }}
          NODE_ENV: production

      - name: Check build output
        run: |
          if [ ! -d "dist" ] || [ -z "$(ls -A dist)" ]; then
            echo "âŒ Build failed: dist directory is empty"
            exit 1
          fi
          echo "âœ… Build successful"
          BUILD_SIZE=$(du -sh dist/ | cut -f1)
          echo "ðŸ“¦ Build size: $BUILD_SIZE"

      - name: PR Summary
        run: |
          echo "## âœ… PR Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Branch name validated" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… PR target validated" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Dependencies installed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Build successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Ready for review!** ðŸš€" >> $GITHUB_STEP_SUMMARY

  comment-pr:
    name: Comment on PR
    runs-on: ubuntu-latest
    needs: validate-pr
    if: success()
    
    steps:
      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… **PR Validation Passed**\n\n- âœ… Branch name follows convention\n- âœ… PR target is valid\n- âœ… Build successful\n- âœ… Ready for code review\n\n**Next Steps:**\n1. Request reviewers\n2. Address any feedback\n3. Wait for approval\n4. Merge when ready! ðŸš€'
            })

